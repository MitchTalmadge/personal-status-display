globals:
  - id: status_change_time
    type: time_t
    initial_value: '0'
  - id: current_display_status
    type: std::string
    restore_value: no
    initial_value: '"${status_sleeping}"'

text_sensor:
  - platform: homeassistant
    id: mitch_status
    entity_id: input_select.mitch_status
    on_value:
      then:
        - script.execute: update_display
  - platform: homeassistant
    id: mitch_location
    entity_id: person.mitch_talmadge
    on_value:
      then:
        - script.execute: update_display

script:
  - id: update_clock
    then:
      - lvgl.label.update:
          id: clock_text
          text: !lambda |-
            static char buf[32];
            auto time = id(ha_time).now();
            int hour = time.hour;
            const char* am_pm = hour >= 12 ? "PM" : "AM";
            if (hour > 12) hour -= 12;
            if (hour == 0) hour = 12;
            snprintf(buf, sizeof(buf), "%d:%02d %s", hour, time.minute, am_pm);
            return buf;
      - lvgl.label.update:
          id: status_duration
          text: !lambda |-
            static char buf[64];
            auto now = ::time(nullptr);
            
            // Get start time and drop seconds
            struct tm *start_tm = localtime(&id(status_change_time));
            start_tm->tm_sec = 0;
            time_t start_time_no_seconds = mktime(start_tm);
            
            // Get current time and drop seconds
            struct tm *now_tm = localtime(&now);
            now_tm->tm_sec = 0;
            time_t now_no_seconds = mktime(now_tm);
            
            // Calculate elapsed time in minutes (no seconds)
            time_t elapsed = now_no_seconds - start_time_no_seconds;
            if (elapsed < 0) elapsed = 0;
            
            int total_minutes = elapsed / 60;
            int hours = total_minutes / 60;
            int minutes = total_minutes % 60;
            
            // Get the start time for display (already has seconds dropped)
            int status_hour = start_tm->tm_hour;
            const char* am_pm = status_hour >= 12 ? "PM" : "AM";
            if (status_hour > 12) status_hour -= 12;
            if (status_hour == 0) status_hour = 12;
            
            // Format duration - hide hours if 0
            if (hours > 0) {
              snprintf(buf, sizeof(buf), "since %d:%02d %s (%dh:%02dm)", 
                       status_hour, start_tm->tm_min, am_pm, hours, minutes);
            } else {
              snprintf(buf, sizeof(buf), "since %d:%02d %s (%dm)", 
                       status_hour, start_tm->tm_min, am_pm, minutes);
            }
            return buf;
  - id: update_display
    then:
      - lambda: |-
          std::string location = id(mitch_location).state;
          std::string status = id(mitch_status).state;
          std::string new_display_status;
          
          // Determine the display status based on location and status
          if (location == "${location_home}") {
            if (status == "${status_sleeping}") {
              new_display_status = "${status_sleeping}";
            } else if (status == "${status_working}") {
              new_display_status = "${status_working}";
            } else if (status == "${status_gaming}") {
              new_display_status = "${status_gaming}";
            } else if (status == "${status_meeting}") {
              new_display_status = "${status_meeting}";
            } else if (status == "${status_busy}") {
              new_display_status = "${status_busy}";
            } else {
              new_display_status = "${status_home}";
            }
          } else {
            new_display_status = "${status_away}";
          }
          
          // Check if status actually changed and update timer
          if (new_display_status != id(current_display_status)) {
            id(current_display_status) = new_display_status;
            id(status_change_time) = ::time(nullptr);
          }
      - script.execute: update_ui
      - lvgl.widget.redraw
      - script.execute: update_clock
  
  - id: update_ui
    then:
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_home}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_home}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_home}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_home}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_home}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_sleeping}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_sleeping}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_sleeping}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_sleeping}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_sleeping}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_working}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_working}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_working}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_working}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_working}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_gaming}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_gaming}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_gaming}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_gaming}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_gaming}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_meeting}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_meeting}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_meeting}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_meeting}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_meeting}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_busy}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_busy}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_busy}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_busy}
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_busy}
      - if:
          condition:
            lambda: |-
              return id(current_display_status) == "${status_away}";
          then:
            - lvgl.label.update:
                id: status_text
                text: "${status_away}"
            - lvgl.label.update:
                id: status_icon
                text: "${icon_away}"
                text_font: font_icons_150
            - lvgl.label.update:
                id: status_text
                text_color: ${color_away}
      # Show or hide duration label based on current status
      - if:
          condition:
            lambda: |-
              std::string statuses_str = "${statuses_with_duration}";
              std::string current = id(current_display_status);
              
              // Check if current status is in the list
              size_t pos = 0;
              while (pos < statuses_str.length()) {
                size_t comma = statuses_str.find(',', pos);
                std::string status = statuses_str.substr(pos, comma - pos);
                // Trim whitespace
                status.erase(0, status.find_first_not_of(" \t"));
                status.erase(status.find_last_not_of(" \t") + 1);
                
                if (status == current) {
                  return true;
                }
                
                if (comma == std::string::npos) break;
                pos = comma + 1;
              }
              return false;
          then:
            - lvgl.widget.show:
                id: status_duration
          else:
            - lvgl.widget.hide:
                id: status_duration
            - lvgl.label.update:
                id: status_icon
                text_color: ${color_away}

interval:
  - interval: 1s
    then:
      - script.execute: update_clock